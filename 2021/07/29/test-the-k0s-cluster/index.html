<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;dark&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="发现一个宿主机二进制部署 Kubernetes 的好工具 -&gt; k0s"><meta name="author" content="bleem"><meta name="keywords" content="k0s,k0sctl,Kubernetes"><title>k0s 折腾笔记 - bleem</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/atom-one-dark-reasonable.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"mritd.com",root:"/",version:"1.8.11",typing:{enable:!0,typeSpeed:80,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"❡"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:200}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:null,google:"UA-179552593-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="bleem" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="bleem" type="application/rss+xml">
</head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>bleem</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/friends/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="k0s 折腾笔记"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-07-29 14:13" pubdate>2021年7月29日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 64 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">k0s 折腾笔记</h1><div class="markdown-body"><blockquote><p>最近两年一直在使用 kubeadm 部署 kubernetes 集群，总体来说配合一些自己小脚本还有一些自动化工具还算是方便；但是全容器化稳定性确实担忧，也遇到过莫名其妙的证书过期错误，最后重启大法解决这种问题；所以也在探索比较方便的二进制部署方式，比如这个 k0s。</p></blockquote><h2 id="一、k0s-介绍"><a href="#一、k0s-介绍" class="headerlink" title="一、k0s 介绍"></a>一、k0s 介绍</h2><blockquote><p>The Simple, Solid &amp; Certified Kubernetes Distribution.</p></blockquote><p>k0s 可以认为是一个下游的 Kubernetes 发行版，与原生 Kubernetes 相比，k0s 并未阉割大量 Kubernetes 功能；k0s 主要阉割部分基本上只有<strong>树内 Cloud provider</strong>，其他的都与原生 Kubernetes 相同。</p><p><strong>k0s 自行编译 Kubernetes 源码生成 Kubernetes 二进制文件，然后在安装后将二进制文件释放到宿主机再启动；这种情况下所有功能几乎与原生 Kubernetes 没有差异。</strong></p><h2 id="二、k0sctl-使用"><a href="#二、k0sctl-使用" class="headerlink" title="二、k0sctl 使用"></a>二、k0sctl 使用</h2><p>k0sctl 是 k0s 为了方便快速部署集群所提供的工具，有点类似于 kubeadm，但是其扩展性要比 kubeadm 好得多。在多节点的情况下，k0sctl 通过 ssh 链接目标主机然后按照步骤释放文件并启动 Kubernetes 相关服务，从而完成集群初始化。</p><h3 id="2-1、k0sctl-安装集群"><a href="#2-1、k0sctl-安装集群" class="headerlink" title="2.1、k0sctl 安装集群"></a>2.1、k0sctl 安装集群</h3><p>安装过程中会自动下载相关镜像，需要保证所有节点可以扶墙，如何离线安装后面讲解。<strong>安装前保证目标机器的 hostname 为非域名形式，否则可能会出现一些问题。</strong>以下是一个简单的启动集群示例:</p><p><strong>首先安装 k0sctl</strong></p><div class="hljs code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 安装 k0sctl</span>
wget https://github.com/k0sproject/k0sctl/releases/download/v0.9.0/k0sctl-linux-x64
chmod +x k0sctl-linux-x64
mv k0sctl-linux-x64 /usr/<span class="hljs-built_in">local</span>/bin/k0sctl</code></pre></div><p><strong>然后编写 k0sctl.yaml 配置文件</strong></p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.14</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.15</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span>
  <span class="hljs-attr">k0s:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">1.21</span><span class="hljs-number">.2</span><span class="hljs-string">+k0s.1</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0s.k0sproject.io/v1beta1</span>
      <span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">metadata:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">k0s</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">api:</span>
          <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-attr">port:</span> <span class="hljs-number">6443</span>
          <span class="hljs-attr">k0sApiPort:</span> <span class="hljs-number">9443</span>
          <span class="hljs-attr">sans:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
        <span class="hljs-attr">storage:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">etcd</span>
          <span class="hljs-attr">etcd:</span>
            <span class="hljs-attr">peerAddress:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
        <span class="hljs-attr">network:</span>
          <span class="hljs-attr">kubeProxy:</span>
            <span class="hljs-attr">disabled:</span> <span class="hljs-literal">false</span>
            <span class="hljs-attr">mode:</span> <span class="hljs-string">ipvs</span></code></pre></div><p><strong>最后执行 <code>apply</code> 命令安装即可，安装前确保你的操作机器可以 ssh 免密登陆所有目标机器:</strong></p><div class="hljs code-wrapper"><pre><code class="hljs sh">➜  tmp k0sctl apply -c bak.yaml

⠀⣿⣿⡇⠀⠀⢀⣴⣾⣿⠟⠁⢸⣿⣿⣿⣿⣿⣿⣿⡿⠛⠁⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀█████████ █████████ ███
⠀⣿⣿⡇⣠⣶⣿⡿⠋⠀⠀⠀⢸⣿⡇⠀⠀⠀⣠⠀⠀⢀⣠⡆⢸⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀███          ███    ███
⠀⣿⣿⣿⣿⣟⠋⠀⠀⠀⠀⠀⢸⣿⡇⠀⢰⣾⣿⠀⠀⣿⣿⡇⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀███          ███    ███
⠀⣿⣿⡏⠻⣿⣷⣤⡀⠀⠀⠀⠸⠛⠁⠀⠸⠋⠁⠀⠀⣿⣿⡇⠈⠉⠉⠉⠉⠉⠉⠉⠉⢹⣿⣿⠀███          ███    ███
⠀⣿⣿⡇⠀⠀⠙⢿⣿⣦⣀⠀⠀⠀⣠⣶⣶⣶⣶⣶⣶⣿⣿⡇⢰⣶⣶⣶⣶⣶⣶⣶⣶⣾⣿⣿⠀█████████    ███    ██████████

k0sctl 0.0.0 Copyright 2021, k0sctl authors.
Anonymized telemetry of usage will be sent to the authors.
By continuing to use k0sctl you agree to these terms:
https://k0sproject.io/licenses/eula
INFO ==&gt; Running phase: Connect to hosts
INFO [ssh] 10.0.0.15:22: connected
INFO [ssh] 10.0.0.11:22: connected
INFO [ssh] 10.0.0.12:22: connected
INFO [ssh] 10.0.0.14:22: connected
INFO [ssh] 10.0.0.13:22: connected
INFO ==&gt; Running phase: Detect host operating systems
INFO [ssh] 10.0.0.11:22: is running Ubuntu 20.04.2 LTS
INFO [ssh] 10.0.0.12:22: is running Ubuntu 20.04.2 LTS
INFO [ssh] 10.0.0.14:22: is running Ubuntu 20.04.2 LTS
INFO [ssh] 10.0.0.13:22: is running Ubuntu 20.04.2 LTS
INFO [ssh] 10.0.0.15:22: is running Ubuntu 20.04.2 LTS
INFO ==&gt; Running phase: Prepare hosts
INFO ==&gt; Running phase: Gather host facts
INFO [ssh] 10.0.0.11:22: discovered ens33 as private interface
INFO [ssh] 10.0.0.13:22: discovered ens33 as private interface
INFO [ssh] 10.0.0.12:22: discovered ens33 as private interface
INFO ==&gt; Running phase: Download k0s on hosts
INFO [ssh] 10.0.0.11:22: downloading k0s 1.21.2+k0s.1
INFO [ssh] 10.0.0.13:22: downloading k0s 1.21.2+k0s.1
INFO [ssh] 10.0.0.12:22: downloading k0s 1.21.2+k0s.1
INFO [ssh] 10.0.0.15:22: downloading k0s 1.21.2+k0s.1
INFO [ssh] 10.0.0.14:22: downloading k0s 1.21.2+k0s.1
......</code></pre></div><p>稍等片刻后带有三个 Master 和两个 Node 的集群将安装完成:</p><div class="hljs code-wrapper"><pre><code class="hljs sh"><span class="hljs-comment"># 注意: 目标机器 hostname 不应当为域名形式，这里的样例是已经修复了这个问题</span>
k1.node ➜ ~ k0s kubectl get node -o wide
NAME      STATUS   ROLES    AGE   VERSION       INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k1.node   Ready    &lt;none&gt;   10m   v1.21.2+k0s   10.0.0.11     &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-77-generic   containerd://1.4.6
k2.node   Ready    &lt;none&gt;   10m   v1.21.2+k0s   10.0.0.12     &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-77-generic   containerd://1.4.6
k3.node   Ready    &lt;none&gt;   10m   v1.21.2+k0s   10.0.0.13     &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-77-generic   containerd://1.4.6
k4.node   Ready    &lt;none&gt;   10m   v1.21.2+k0s   10.0.0.14     &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-77-generic   containerd://1.4.6
k5.node   Ready    &lt;none&gt;   10m   v1.21.2+k0s   10.0.0.15     &lt;none&gt;        Ubuntu 20.04.2 LTS   5.4.0-77-generic   containerd://1.4.6</code></pre></div><h3 id="2-2、k0sctl-的扩展方式"><a href="#2-2、k0sctl-的扩展方式" class="headerlink" title="2.2、k0sctl 的扩展方式"></a>2.2、k0sctl 的扩展方式</h3><p>与 kubeadm 不同，k0sctl 几乎提供了所有安装细节的可定制化选项，其通过三种行为来完成扩展:</p><ul><li><strong>文件上传:</strong> k0sctl 允许定义在安装前的文件上传，在安装之前 k0sctl 会把已经定义的相关文件全部上传到目标主机，包括不限于 k0s 本身二进制文件、离线镜像包、其他安装文件、其他辅助脚本等。</li><li><strong>Manifests 与 Helm:</strong> 当将特定的文件上传到 master 节点的 <code>/var/lib/k0s/manifests</code> 目录时，k0s 在安装过程中会自动应用这些配置，类似 kubelet 的 static pod 一样，只不过 k0s 允许全部资源(包括不限于 deployment、daemonset、namespace 等)；同样也可以直接在 <code>k0sctl.yaml</code> 添加 Helm 配置，k0s 也会以同样的方式帮你管理。</li><li><strong>辅助脚本:</strong> 可以在每个主机下配置 <code>hooks</code> 选项来实现执行一些特定的脚本(文档里没有，需要看源码)，以便在特定情况下做点骚操作。</li></ul><h3 id="2-3、k0sctl-使用离线镜像包"><a href="#2-3、k0sctl-使用离线镜像包" class="headerlink" title="2.3、k0sctl 使用离线镜像包"></a>2.3、k0sctl 使用离线镜像包</h3><p>基于上面的扩展，k0s 还方便的帮我们集成了离线镜像包的自动导入，我们只需要定义一个文件上传，将镜像包上传到 <code>/var/lib/k0s/images/</code> 目录后，k0s 会自定将其倒入到 containerd 中而无需我们手动干预:</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-comment"># files 配置将会在安装前将相关文件上传到目标主机</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-comment"># 在该目录下的 image 压缩包将会被自动导入到 containerd 中</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
<span class="hljs-string">......</span></code></pre></div><p><strong>关于 image 压缩包(bundle_file)如何下载以及自己自定义问题请参考官方 <a target="_blank" rel="noopener" href="https://docs.k0sproject.io/v1.21.2+k0s.1/airgap-install/">Airgap install</a> 文档。</strong></p><p><img src="https://cdn.oss.link/markdown/LJIS7j.png" srcset="/img/loading.gif" lazyload></p><h3 id="2-4、切换-CNI-插件"><a href="#2-4、切换-CNI-插件" class="headerlink" title="2.4、切换 CNI 插件"></a>2.4、切换 CNI 插件</h3><p>默认情况下 k0s 内部集成了两个 CNI 插件: calico 和 kube-router；如果我们使用其他的 CNI 插件例如 flannel，我们只需要将默认的 CNI 插件设置为 <code>custom</code>，然后将 flannel 的部署 yaml 上传到一台 master 的 <code>/var/lib/k0s/manifests</code> 目录即可，k0s 会自动帮我门执行 <code>apply -f xxxx.yaml</code> 这种操作。</p><p>下面是切换到 flannel 的样例，需要注意的是 flannel 官方镜像不会帮你安装 CNI 的二进制文件，我们需要借助文件上传自己安装(<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/releases">CNI GitHub 插件下载地址</a>):</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-comment"># 将 flannel 的 yaml 放到 manifests 里(需要单独创建一个目录)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/kube-flannel.yaml</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/manifests/flannel</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0644</span>
    <span class="hljs-comment"># 自己安装一下 CNI 插件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-attr">k0s:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.21.2+k0s.1</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0s.k0sproject.io/v1beta1</span>
      <span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">metadata:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">k0s</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">api:</span>
          <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-attr">port:</span> <span class="hljs-number">6443</span>
          <span class="hljs-attr">k0sApiPort:</span> <span class="hljs-number">9443</span>
          <span class="hljs-attr">sans:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
        <span class="hljs-attr">storage:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">etcd</span>
        <span class="hljs-attr">network:</span>
          <span class="hljs-attr">podCIDR:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span>
          <span class="hljs-attr">serviceCIDR:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/12</span>
          <span class="hljs-comment"># 这里指定 CNI 为 custom 自定义类型，这样</span>
          <span class="hljs-comment"># k0s 就不会安装 calico/kube-router 了</span>
          <span class="hljs-attr">provider:</span> <span class="hljs-string">custom</span></code></pre></div><h3 id="2-5、上传-k0s-二进制文件"><a href="#2-5、上传-k0s-二进制文件" class="headerlink" title="2.5、上传 k0s 二进制文件"></a>2.5、上传 k0s 二进制文件</h3><p>除了普通文件、镜像压缩包等，默认情况下 k0sctl 在安装集群时还会在目标机器上下载 k0s 二进制文件；当然在离线环境下这一步也可以通过一个简单的配置来实现离线上传:</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-comment"># 声明需要上传二进制文件</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 指定二进制文件位置</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/kube-flannel.yaml</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/manifests/flannel</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0644</span>
<span class="hljs-string">......</span></code></pre></div><h3 id="2-6、更换镜像版本"><a href="#2-6、更换镜像版本" class="headerlink" title="2.6、更换镜像版本"></a>2.6、更换镜像版本</h3><p>默认情况下 k0s 版本号与 Kubernetes 保持一致，但是如果期望某个组件使用特定的版本，则可以直接配置这些内置组件的镜像名称:</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/kube-flannel.yaml</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/manifests/flannel</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0644</span>
<span class="hljs-string">......</span>
  <span class="hljs-attr">k0s:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.21.2+k0s.1</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0s.k0sproject.io/v1beta1</span>
      <span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">metadata:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">k0s</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">api:</span>
          <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-attr">port:</span> <span class="hljs-number">6443</span>
          <span class="hljs-attr">k0sApiPort:</span> <span class="hljs-number">9443</span>
          <span class="hljs-attr">sans:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
        <span class="hljs-comment"># 指定内部组件的镜像使用的版本</span>
        <span class="hljs-attr">images:</span>
          <span class="hljs-comment">#konnectivity:</span>
          <span class="hljs-comment">#  image: us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-agent</span>
          <span class="hljs-comment">#  version: v0.0.21</span>
          <span class="hljs-comment">#metricsserver:</span>
          <span class="hljs-comment">#  image: gcr.io/k8s-staging-metrics-server/metrics-server</span>
          <span class="hljs-comment">#  version: v0.3.7</span>
          <span class="hljs-attr">kubeproxy:</span>
            <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/kube-proxy</span>
            <span class="hljs-attr">version:</span> <span class="hljs-string">v1.21.3</span>
          <span class="hljs-comment">#coredns:</span>
          <span class="hljs-comment">#  image: docker.io/coredns/coredns</span>
          <span class="hljs-comment">#  version: 1.7.0</span>
          <span class="hljs-comment">#calico:</span>
          <span class="hljs-comment">#  cni:</span>
          <span class="hljs-comment">#    image: docker.io/calico/cni</span>
          <span class="hljs-comment">#    version: v3.18.1</span>
          <span class="hljs-comment">#  node:</span>
          <span class="hljs-comment">#    image: docker.io/calico/node</span>
          <span class="hljs-comment">#    version: v3.18.1</span>
          <span class="hljs-comment">#  kubecontrollers:</span>
          <span class="hljs-comment">#    image: docker.io/calico/kube-controllers</span>
          <span class="hljs-comment">#    version: v3.18.1</span>
          <span class="hljs-comment">#kuberouter:</span>
          <span class="hljs-comment">#  cni:</span>
          <span class="hljs-comment">#    image: docker.io/cloudnativelabs/kube-router</span>
          <span class="hljs-comment">#    version: v1.2.1</span>
          <span class="hljs-comment">#  cniInstaller:</span>
          <span class="hljs-comment">#    image: quay.io/k0sproject/cni-node</span>
          <span class="hljs-comment">#    version: 0.1.0</span>
          <span class="hljs-attr">default_pull_policy:</span> <span class="hljs-string">IfNotPresent</span>
          <span class="hljs-comment">#default_pull_policy: Never</span></code></pre></div><h3 id="2-7、调整-master-组件参数"><a href="#2-7、调整-master-组件参数" class="headerlink" title="2.7、调整 master 组件参数"></a>2.7、调整 master 组件参数</h3><p>熟悉 Kubernetes 的应该清楚，master 上三大组件: apiserver、controller、scheduler 管控整个集群；在 k0sctl 安装集群的过程中也允许自定义这些组件的参数，这些调整通过修改使用的 <code>k0sctl.yaml</code> 配置文件完成。</p><ul><li><code>spec.api.extraArgs</code>: 用于自定义 kube-apiserver 的自定义参数(kv map)</li><li><code>spec.scheduler.extraArgs</code>: 用于自定义 kube-scheduler 的自定义参数(kv map)</li><li><code>spec.controllerManager.extraArgs</code>: 用于自定义 kube-controller-manager 自定义参数(kv map)</li><li><code>spec.workerProfiles</code>: 用于覆盖 kubelet-config.yaml 中的配置，该配置最终将于默认的 kubelet-config.yaml 合并</li></ul><p>除此之外在 <code>Host</code> 配置中还有一个 <code>InstallFlags</code> 配置用于传递 k0s 安装时的其他配置选项。</p><h2 id="三、k0s-HA-搭建"><a href="#三、k0s-HA-搭建" class="headerlink" title="三、k0s HA 搭建"></a>三、k0s HA 搭建</h2><blockquote><p>其实上面的第二部分主要都是介绍 k0sctl 一些基础功能，为的就是给下面这部分 HA 生产级部署做铺垫。</p></blockquote><p>就目前来说，k0s HA 仅支持独立负载均衡器的 HA 架构；<strong>即外部需要有一个高可用的 4 层负载均衡器，其他所有 Node 节点链接这个负载均衡器实现 master 的高可用。</strong>在使用 k0sctl 命令搭建 HA 集群时很简单，只需要添加一个外部负载均衡器地址即可；<strong>以下是一个完整的，全离线状态下的 HA 集群搭建配置。</strong></p><h3 id="3-1、外部负载均衡器"><a href="#3-1、外部负载均衡器" class="headerlink" title="3.1、外部负载均衡器"></a>3.1、外部负载均衡器</h3><p><strong>在搭建之前我们假设已经有一个外部的高可用的 4 层负载均衡器，且负载均衡器已经负载了以下端口:</strong></p><ul><li><code>6443(for Kubernetes API)</code>: 负载均衡器 6443 负载所有 master 节点的 6443</li><li><code>9443 (for controller join API)</code>: 负载均衡器 9443 负载所有 master 节点的 9443</li><li><code>8132 (for Konnectivity agent)</code>: 负载均衡器 8132 负载所有 master 节点的 8132</li><li><code>8133 (for Konnectivity server)</code>: 负载均衡器 8133 负载所有 master 节点的 8133</li></ul><p>以下为一个 nginx 4 层代理的样例:</p><div class="hljs code-wrapper"><pre><code class="hljs sh">error_log syslog:server=unix:/dev/<span class="hljs-built_in">log</span> notice;

worker_processes auto;
events &#123;
	multi_accept on;
	use epoll;
	worker_connections 1024;
&#125;

stream &#123;
    upstream kube_apiserver &#123;
        least_conn;
        server 10.0.0.11:6443;
        server 10.0.0.12:6443;
        server 10.0.0.13:6443;
    &#125;
    upstream konnectivity_agent &#123;
        least_conn;
        server 10.0.0.11:8132;
        server 10.0.0.12:8132;
        server 10.0.0.13:8132;
    &#125;
    upstream konnectivity_server &#123;
        least_conn;
        server 10.0.0.11:8133;
        server 10.0.0.12:8133;
        server 10.0.0.13:8133;
    &#125;
    upstream controller_join_api &#123;
        least_conn;
        server 10.0.0.11:9443;
        server 10.0.0.12:9443;
        server 10.0.0.13:9443;
    &#125;
    
    server &#123;
        listen        0.0.0.0:6443;
        proxy_pass    kube_apiserver;
        proxy_timeout 10m;
        proxy_connect_timeout 1s;
    &#125;
    server &#123;
        listen        0.0.0.0:8132;
        proxy_pass    konnectivity_agent;
        proxy_timeout 10m;
        proxy_connect_timeout 1s;
    &#125;
    server &#123;
        listen        0.0.0.0:8133;
        proxy_pass    konnectivity_server;
        proxy_timeout 10m;
        proxy_connect_timeout 1s;
    &#125;
    server &#123;
        listen        0.0.0.0:9443;
        proxy_pass    controller_join_api;
        proxy_timeout 10m;
        proxy_connect_timeout 1s;
    &#125;
&#125;</code></pre></div><h3 id="3-2、搭建-HA-集群"><a href="#3-2、搭建-HA-集群" class="headerlink" title="3.2、搭建 HA 集群"></a>3.2、搭建 HA 集群</h3><p>以下为 k0sctl 的 HA + 离线部署样例配置:</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0sctl.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s-cluster</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-comment"># role 支持的值</span>
    <span class="hljs-comment"># &#x27;controller&#x27; 单 master</span>
    <span class="hljs-comment"># &#x27;worker&#x27; 单 worker</span>
    <span class="hljs-comment"># &#x27;controller+worker&#x27; master 和 worker 都运行 </span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    
    <span class="hljs-comment"># 从本地 上传 k0s bin 文件，不要在目标机器下载</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    
    <span class="hljs-comment"># 上传其他文件</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-comment"># 上传 flannel 配置，使用自定的 flannel 替换内置的 calico</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">flannel</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/kube-flannel.yaml</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/manifests/flannel</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0644</span>
    
    <span class="hljs-comment"># 上传打包好的 image 镜像包，k0s 会自动导入到 containerd</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
    
    <span class="hljs-comment"># 使用 flannel 后每个机器要上传对应的 CNI 插件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">controller+worker</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.14</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ssh:</span>
      <span class="hljs-attr">address:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.15</span>
      <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
      <span class="hljs-attr">keyPath:</span> <span class="hljs-string">/Users/bleem/.ssh/id_rsa</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">worker</span>
    <span class="hljs-attr">uploadBinary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">k0sBinaryPath:</span> <span class="hljs-string">/Users/bleem/tmp/k0s</span>
    <span class="hljs-attr">files:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image-bundle</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/bundle_file</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/var/lib/k0s/images/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cni-plugins</span>
      <span class="hljs-attr">src:</span> <span class="hljs-string">/Users/bleem/tmp/cni-plugins/*</span>
      <span class="hljs-attr">dstDir:</span> <span class="hljs-string">/opt/cni/bin/</span>
      <span class="hljs-attr">perm:</span> <span class="hljs-number">0755</span>
  <span class="hljs-attr">k0s:</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.21.2+k0s.1</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0s.k0sproject.io/v1beta1</span>
      <span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">metadata:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">k0s</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">api:</span>
          <span class="hljs-comment"># 此处填写外部的负载均衡器地址，所有 kubelet 会链接这个地址</span>
          <span class="hljs-attr">externalAddress:</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.20</span>
          <span class="hljs-comment"># 不要忘了为外部负载均衡器添加 api 证书的 SAN</span>
          <span class="hljs-attr">sans:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.13</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.20</span>
        <span class="hljs-comment"># 存储类型使用 etcd，etcd 集群由 k0s 自动管理</span>
        <span class="hljs-attr">storage:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">etcd</span>
        <span class="hljs-attr">network:</span>
          <span class="hljs-attr">podCIDR:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span>
          <span class="hljs-attr">serviceCIDR:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/12</span>
          <span class="hljs-comment"># 网络插件使用 custom，然后让 flannel 接管</span>
          <span class="hljs-attr">provider:</span> <span class="hljs-string">custom</span>
          <span class="hljs-attr">kubeProxy:</span>
            <span class="hljs-attr">disabled:</span> <span class="hljs-literal">false</span>
            <span class="hljs-comment"># 开启 kubelet 的 ipvs 模式</span>
            <span class="hljs-attr">mode:</span> <span class="hljs-string">ipvs</span>
        <span class="hljs-comment"># 不发送任何匿名统计信息</span>
        <span class="hljs-attr">telemetry:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
        <span class="hljs-attr">images:</span>
          <span class="hljs-attr">default_pull_policy:</span> <span class="hljs-string">IfNotPresent</span></code></pre></div><p>最后只需要执行 <code>k0sctl apply -c k0sctl.yaml</code> 稍等几分钟集群就搭建好了，安装过程中可以看到相关文件的上传流程:</p><p><img src="https://cdn.oss.link/markdown/4rQzJU.png" srcset="/img/loading.gif" lazyload></p><h3 id="3-3、证书续签和管理"><a href="#3-3、证书续签和管理" class="headerlink" title="3.3、证书续签和管理"></a>3.3、证书续签和管理</h3><p>kubeadm 集群默认证书有效期是一年，到期要通过 kubeadm 重新签署；k0s 集群也差不多一样，但是不同的是 k0s 集群更加暴力；<strong>只要 CA(默认 10年) 不丢，k0s 每次重启都强行重新生成一年有效期的证书，所以在 HA 的环境下，快到期时重启一下 k0s 服务就行。</strong></p><p><strong>k0sctl 安装完的集群默认只有一个 <code>k0scontroller.service</code> 服务，master、node 上所有服务都由这个服务启动，所以到期之前 <code>systemctl restart k0scontroller.service</code> 一下就行。</strong></p><h2 id="四、集群备份和恢复"><a href="#四、集群备份和恢复" class="headerlink" title="四、集群备份和恢复"></a>四、集群备份和恢复</h2><p>k0sctl 提供了集群备份和恢复功能，默认情况下只需要执行 <code>k0sctl backup</code> 即可完成集群备份，该命令会在当前目录下生成一个 <code>k0s_backup_TIMESTAMP.tar.gz</code> 备份文件。</p><p>需要恢复集群时使用 <code>k0sctl apply --restore-from k0s_backup_TIMESTAMP.tar.gz</code> 命令进行恢复即可；需要注意的是恢复命令等同于在新机器重新安装集群，所以有一定风险。</p><p><strong>经过连续两天的测试，感觉这个备份恢复功能并不算靠谱，还是推荐使用 Velero 备份集群。</strong></p><h2 id="五、其他高级功能"><a href="#五、其他高级功能" class="headerlink" title="五、其他高级功能"></a>五、其他高级功能</h2><h3 id="5-1、Etcd-替换"><a href="#5-1、Etcd-替换" class="headerlink" title="5.1、Etcd 替换"></a>5.1、Etcd 替换</h3><p>在小规模集群场景下可能并不需要特别完善的 Etcd 作为存储，k0s 借助于 kine 库可以实现使用 SQLite 或 MySQL 等传统数据库作为集群存储；如果想要切换存储只需要调整 <code>k0sctl.yaml</code> 配置即可:</p><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">k0s.k0sproject.io/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Cluster</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k0s</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">storage:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">kine</span>
    <span class="hljs-attr">kine:</span>
      <span class="hljs-attr">dataSource:</span> <span class="hljs-string">&quot;sqlite:///var/lib/k0s/db/state.db?more=rwc&amp;_journal=WAL&amp;cache=shared&quot;</span></code></pre></div><h3 id="5-2、集群用户管理"><a href="#5-2、集群用户管理" class="headerlink" title="5.2、集群用户管理"></a>5.2、集群用户管理</h3><p>使用 k0sctl 搭建的集群通过 <code>k0s</code> 命令可以很方便的为集群添加用户，以下是添加样例:</p><div class="hljs code-wrapper"><pre><code class="hljs sh">k0s kubeconfig create --groups <span class="hljs-string">&quot;system:masters&quot;</span> testUser &gt; k0s.config</code></pre></div><h3 id="5-3、Containerd-配置"><a href="#5-3、Containerd-配置" class="headerlink" title="5.3、Containerd 配置"></a>5.3、Containerd 配置</h3><p>在不做配置的情况下 k0s 集群使用默认的 Containerd 配置，如果需要自己定义特殊配置，可以在安装时通过文件上传方式将 Containerd 配置文件上传到 <code>/etc/k0s/containerd.toml</code> 位置，该配置将会被 k0s 启动的 Containerd 读取并使用。</p><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>k0s 是个不错的项目，对于二进制宿主机部署 Kubernetes 集群很方便，由于其直接采用 Kubernetes 二进制文件启动，所以基本没有功能阉割，而 k0sctl 又为自动化安装提供了良好的扩展性，所以值得一试。不过目前来说 k0s 在细节部分还有一定瑕疵，比如 <code>konnectivity</code> 服务在安装时无法选择性关闭等；k0s 综合来说是个不错的工具，也推荐看看源码，里面很多设计很新颖也比较利于了解集群引导过程。</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/kubernetes/">Kubernetes</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/kubernetes/">Kubernetes</a> <a class="hover-with-bg" href="/tags/k0s/">k0s</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 国际许可协议进行许可，转载请注明出处。</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2021/07/02/fix-caddy2-fileserver-auto-redirect/"><span class="hidden-mobile">Caddy2 file server 自动重定向问题</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://mritd.com/2021/07/29/test-the-k0s-cluster/",this.page.identifier="/2021/07/29/test-the-k0s-cluster/"};Fluid.utils.loadComments("#disqus_thread",(function(){var t=document,e=t.createElement("script");e.src="//bleem.disqus.com/embed.js",e.setAttribute("data-timestamp",new Date),(t.head||t.body).appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:200}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="/js/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-179552593-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script src="/js/boot.js"></script></body></html>